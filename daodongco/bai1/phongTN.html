<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Lab Ultimate - Web Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        input[type=range] { accent-color: #4f46e5; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-btn { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 flex justify-between items-center z-20 shrink-0 shadow-md">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-500 p-1.5 rounded-lg text-white"><i class="fa-solid fa-atom"></i></div>
            <h1 class="text-sm font-black uppercase tracking-widest hidden md:block">Physics Lab Ultimate</h1>
        </div>
        
        <nav class="flex bg-slate-800 p-1 rounded-xl border border-slate-700" id="tab-nav">
            <button onclick="switchTab('pendulum')" id="btn-pendulum" class="tab-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase bg-indigo-600 text-white shadow-sm">
                <i class="fa-solid fa-water"></i> <span class="hidden sm:inline">Con Lắc Đơn</span>
            </button>
            <button onclick="switchTab('spring')" id="btn-spring" class="tab-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase text-slate-400 hover:text-white">
                <i class="fa-solid fa-bolt"></i> <span class="hidden sm:inline">Lò Xo</span>
            </button>
            <button onclick="switchTab('damped')" id="btn-damped" class="tab-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase text-slate-400 hover:text-white">
                <i class="fa-solid fa-wind"></i> <span class="hidden sm:inline">Tắt Dần</span>
            </button>
            <button onclick="switchTab('resonance')" id="btn-resonance" class="tab-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase text-slate-400 hover:text-white">
                <i class="fa-solid fa-circle-nodes"></i> <span class="hidden sm:inline">Cộng Hưởng</span>
            </button>
        </nav>

        <div class="flex gap-2">
            <button id="play-pause" onclick="toggleRun()" class="w-9 h-9 rounded-xl flex items-center justify-center text-white active:scale-95 transition-all bg-emerald-500 shadow-lg shadow-emerald-900/20">
                <i class="fa-solid fa-play ml-0.5" id="play-icon"></i>
            </button>
            <button onclick="resetSim()" class="w-9 h-9 rounded-xl bg-slate-700 text-slate-300 flex items-center justify-center border border-slate-600 hover:bg-slate-600 transition-colors">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex p-3 gap-3 overflow-hidden">
        <!-- Simulation View -->
        <div class="flex-[2.5] bg-white rounded-2xl shadow-sm border border-slate-200 relative flex flex-col overflow-hidden">
            <div class="absolute top-4 left-6 flex flex-col gap-1 z-10">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]" id="sim-title">Con Lắc Đơn</span>
                <span class="text-xs font-mono font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md border border-indigo-100">T = <span id="time-display">0.00</span>s</span>
            </div>

            <svg width="100%" height="100%" viewBox="0 0 600 400" id="sim-svg">
                <defs>
                    <radialGradient id="ballGrad" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#818cf8" /><stop offset="100%" stop-color="#3730a3" /></radialGradient>
                    <radialGradient id="redGrad" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#fb7185" /><stop offset="100%" stop-color="#9f1239" /></radialGradient>
                    <radialGradient id="greenGrad" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#4ade80" /><stop offset="100%" stop-color="#166534" /></radialGradient>
                    <radialGradient id="amberGrad" cx="30%" cy="30%" r="50%"><stop offset="0%" stop-color="#fbbf24" /><stop offset="100%" stop-color="#92400e" /></radialGradient>
                </defs>
                <g id="sim-content" transform="translate(300, 160)"></g>
            </svg>
        </div>

        <!-- Sidebar -->
        <div class="w-[360px] flex flex-col gap-3 overflow-hidden">
            <!-- Graph -->
            <div class="bg-slate-900 p-4 rounded-2xl shadow-xl border border-slate-800 flex flex-col shrink-0 h-[280px]">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i class="fa-solid fa-chart-line text-indigo-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest" id="graph-title">Đồ thị động học</span>
                    </div>
                    <div class="flex gap-2 text-[8px] font-bold" id="graph-legend">
                        <span class="text-indigo-400">● x</span>
                        <span class="text-emerald-400">● v</span>
                        <span class="text-rose-400">● a</span>
                    </div>
                </div>
                <div class="flex-1 relative bg-black/40 rounded-xl border border-slate-800 overflow-hidden">
                    <svg viewBox="0 0 100 100" class="w-full h-full" preserveAspectRatio="none">
                        <line x1="0" y1="50" x2="100" y2="50" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="2,2" />
                        <polyline id="path-1" points="" fill="none" stroke="#818cf8" stroke-width="1.5" />
                        <polyline id="path-2" points="" fill="none" stroke="#34d399" stroke-width="1.5" />
                        <polyline id="path-3" points="" fill="none" stroke="#fbbf24" stroke-width="1.5" />
                        <polyline id="path-driver" points="" fill="none" stroke="#fb7185" stroke-width="1" stroke-dasharray="1,1" opacity="0.5" />
                    </svg>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-1 overflow-hidden min-h-0">
                <div class="text-[10px] font-black uppercase text-slate-400 mb-4 flex items-center gap-2 border-b border-slate-100 pb-3 shrink-0 tracking-widest">
                    <i class="fa-solid fa-sliders"></i> Bảng điều khiển
                </div>
                <div class="space-y-5 overflow-y-auto pr-2 flex-1 scrollbar-hide" id="controls-container"></div>
                
                <div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-2 gap-2">
                    <div class="bg-slate-50 p-2 rounded-lg text-center border border-slate-100">
                        <div class="text-[8px] font-bold text-slate-400 uppercase">Tần số góc</div>
                        <div class="text-xs font-mono font-bold text-indigo-600" id="val-omega">0.00 rad/s</div>
                    </div>
                    <div class="bg-slate-50 p-2 rounded-lg text-center border border-slate-100">
                        <div class="text-[8px] font-bold text-slate-400 uppercase">Chu kỳ (T)</div>
                        <div class="text-xs font-mono font-bold text-indigo-600" id="val-period">0.00 s</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const state = {
            activeTab: 'pendulum',
            isRunning: false,
            time: 0,
            history: [],
            params: {
                mass: 1.0,
                length: 150,
                kSpring: 25,
                initAmp: 20,
                dampingB: 0.2,
                lDriver: 120
            }
        };

        const MAX_HISTORY = 400;
        const GRAVITY = 9.8;
        let lastTime = 0;
        let animationId = null;

        function switchTab(tab) {
            state.activeTab = tab;
            state.isRunning = false;
            state.time = 0;
            state.history = [];
            if (animationId) cancelAnimationFrame(animationId);
            
            // Update UI Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-sm');
                btn.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-sm');
            activeBtn.classList.remove('text-slate-400');
            
            document.getElementById('sim-title').innerText = activeBtn.querySelector('span').innerText;
            
            // Update Legend and Graph Title
            const legend = document.getElementById('graph-legend');
            const graphTitle = document.getElementById('graph-title');
            if (tab === 'resonance') {
                graphTitle.innerText = "Đồ thị ly độ các con lắc";
                legend.innerHTML = `
                    <span class="text-rose-400">● Mẫu</span>
                    <span class="text-indigo-400">● L=80</span>
                    <span class="text-emerald-400">● L=120</span>
                    <span class="text-amber-400">● L=160</span>
                `;
            } else {
                graphTitle.innerText = "Đồ thị động học";
                legend.innerHTML = `
                    <span class="text-indigo-400">● x</span>
                    <span class="text-emerald-400">● v</span>
                    <span class="text-rose-400">● a</span>
                `;
            }

            updateUIState();
            renderControls();
            updateStats();
            updateSimulation();
            updateGraph();
        }

        function updateUIState() {
            const btn = document.getElementById('play-pause');
            const icon = document.getElementById('play-icon');
            if(state.isRunning) {
                btn.className = "w-9 h-9 rounded-xl flex items-center justify-center text-white active:scale-95 transition-all bg-rose-500 shadow-lg shadow-rose-900/20";
                icon.className = "fa-solid fa-pause";
            } else {
                btn.className = "w-9 h-9 rounded-xl flex items-center justify-center text-white active:scale-95 transition-all bg-emerald-500 shadow-lg shadow-emerald-900/20";
                icon.className = "fa-solid fa-play ml-0.5";
            }
        }

        function toggleRun() {
            state.isRunning = !state.isRunning;
            updateUIState();
            if(state.isRunning) {
                lastTime = performance.now();
                animationId = requestAnimationFrame(loop);
            } else {
                if (animationId) cancelAnimationFrame(animationId);
            }
        }

        function resetSim() {
            state.time = 0;
            state.history = [];
            state.isRunning = false;
            if (animationId) cancelAnimationFrame(animationId);
            updateUIState();
            updateSimulation();
            updateGraph();
            document.getElementById('time-display').innerText = "0.00";
        }

        function getPhysicsConstants() {
            let omega = 1, maxA = 1;
            if (state.activeTab === 'pendulum') {
                omega = Math.sqrt(GRAVITY / (state.params.length / 100));
                maxA = state.params.initAmp * (Math.PI / 180);
            } else if (state.activeTab === 'spring' || state.activeTab === 'damped') {
                omega = Math.sqrt(state.params.kSpring / state.params.mass);
                maxA = 40;
            } else if (state.activeTab === 'resonance') {
                omega = Math.sqrt(GRAVITY / (state.params.lDriver / 100));
                maxA = 0.5;
            }
            return { omega, maxA, maxV: omega * maxA, maxAcc: omega * omega * maxA };
        }

        function calculateData(t) {
            const { omega, maxA } = getPhysicsConstants();
            let x = 0, v = 0, a = 0;
            let extra = {};

            if (state.activeTab === 'pendulum' || state.activeTab === 'spring') {
                x = maxA * Math.cos(omega * t);
                v = -omega * maxA * Math.sin(omega * t);
                a = -omega * omega * maxA * Math.cos(omega * t);
            } else if (state.activeTab === 'damped') {
                const beta = state.params.dampingB / (2 * state.params.mass);
                if (beta < omega) {
                    const wd = Math.sqrt(omega * omega - beta * beta);
                    const env = maxA * Math.exp(-beta * t);
                    x = env * Math.cos(wd * t);
                    v = -beta * x - wd * env * Math.sin(wd * t);
                    a = (beta * beta - wd * wd) * x + 2 * beta * wd * env * Math.sin(wd * t);
                }
            } else if (state.activeTab === 'resonance') {
                const A_res = 8 * (Math.PI / 180);
                x = A_res * Math.cos(omega * t); // Con lắc mẫu
                [80, 120, 160].forEach((l, i) => {
                    const w_nat = Math.sqrt(GRAVITY / (l / 100));
                    const beta = state.params.dampingB * 0.1; 
                    const denom = Math.sqrt(Math.pow(w_nat**2 - omega**2, 2) + Math.pow(2 * beta * omega, 2));
                    // Biên độ cộng hưởng phụ thuộc vào việc w_nat gần với omega thế nào
                    const ampMax = 0.4 / (denom || 0.001);
                    extra[`x${i+1}`] = ampMax * (1 - Math.exp(-beta * t)) * Math.sin(omega * t);
                });
            }
            return { x, v, a, ...extra };
        }

        function updateSimulation() {
            const data = calculateData(state.time);
            const sim = document.getElementById('sim-content');
            
            if (state.activeTab === 'pendulum') {
                const angle = data.x * (180 / Math.PI);
                sim.innerHTML = `
                    <g transform="translate(0, -100) rotate(${angle})">
                        <rect x="-30" y="-4" width="60" height="8" rx="2" fill="#1e293b" />
                        <line x1="0" y1="0" x2="0" y2="${state.params.length * 0.8}" stroke="#475569" stroke-width="3" />
                        <circle cx="0" cy="${state.params.length * 0.8}" r="22" fill="url(#ballGrad)" />
                    </g>
                `;
            } else if (state.activeTab === 'spring' || state.activeTab === 'damped') {
                const springX = data.x;
                let path = "M -180 0";
                for(let i=0; i<16; i++) {
                    const px = -180 + (i+1) * ((springX + 220) / 16);
                    const py = i % 2 === 0 ? -12 : 12;
                    path += ` L ${px} ${py}`;
                }
                sim.innerHTML = `
                    <rect x="-200" y="-40" width="20" height="80" rx="4" fill="#1e293b" />
                    <line x1="-180" y1="40" x2="200" y2="40" stroke="#f1f5f9" stroke-width="4" />
                    <path d="${path}" fill="none" stroke="#64748b" stroke-width="3" />
                    <rect x="${springX + 40}" y="-30" width="60" height="60" rx="8" fill="url(#ballGrad)" />
                `;
            } else if (state.activeTab === 'resonance') {
                let inner = `<line x1="-190" y1="-60" x2="190" y2="-60" stroke="#1e293b" stroke-width="6" stroke-linecap="round" />`;
                // Con lắc điều khiển (màu đỏ)
                inner += `
                    <g transform="translate(-110, -60) rotate(${data.x * 180 / Math.PI})">
                        <line x1="0" y1="0" x2="0" y2="${state.params.lDriver * 0.7}" stroke="#fb7185" stroke-width="3" />
                        <circle cx="0" cy="${state.params.lDriver * 0.7}" r="12" fill="url(#redGrad)" />
                    </g>
                `;
                // 3 Con lắc quan sát
                const colors = ['#818cf8', '#34d399', '#fbbf24'];
                const grads = ['ballGrad', 'greenGrad', 'amberGrad'];
                [80, 120, 160].forEach((l, i) => {
                    const angle = data[`x${i+1}`] * 180 / Math.PI;
                    inner += `
                        <g transform="translate(${-30 + i * 80}, -60) rotate(${angle})">
                            <line x1="0" y1="0" x2="0" y2="${l * 0.7}" stroke="${colors[i]}" stroke-width="2.5" />
                            <circle cx="0" cy="${l * 0.7}" r="10" fill="url(#${grads[i]})" />
                        </g>
                    `;
                });
                sim.innerHTML = inner;
            }
        }

        function updateGraph() {
            const path1 = document.getElementById('path-1');
            const path2 = document.getElementById('path-2');
            const path3 = document.getElementById('path-3');
            const pathDriver = document.getElementById('path-driver');

            if (state.history.length === 0) {
                [path1, path2, path3, pathDriver].forEach(p => p.setAttribute('points', ""));
                return;
            }

            if (state.activeTab === 'resonance') {
                // Tỉ lệ scale cố định cho cộng hưởng để thấy biên độ lớn
                const s = 15; 
                const p1 = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.x1 * s}`).join(' ');
                const p2 = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.x2 * s}`).join(' ');
                const p3 = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.x3 * s}`).join(' ');
                const pd = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.x * s * 2}`).join(' ');

                path1.setAttribute('points', p1);
                path2.setAttribute('points', p2);
                path3.setAttribute('points', p3);
                pathDriver.setAttribute('points', pd);
                pathDriver.style.display = "block";
            } else {
                const { maxA, maxV, maxAcc } = getPhysicsConstants();
                const sx = 40 / (maxA || 1);
                const sv = 40 / (maxV || 1);
                const sa = 40 / (maxAcc || 1);

                const px = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.x * sx}`).join(' ');
                const pv = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.v * sv}`).join(' ');
                const pa = state.history.map((d, i) => `${(i / MAX_HISTORY) * 100},${50 - d.a * sa}`).join(' ');

                path1.setAttribute('points', px);
                path2.setAttribute('points', pv);
                path3.setAttribute('points', pa);
                pathDriver.setAttribute('points', "");
                pathDriver.style.display = "none";
            }
        }

        function loop(timestamp) {
            if (!state.isRunning) return;
            const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
            state.time += dt;
            lastTime = timestamp;

            const currentData = calculateData(state.time);
            state.history.push(currentData);
            if(state.history.length > MAX_HISTORY) state.history.shift();

            document.getElementById('time-display').innerText = state.time.toFixed(2);
            updateSimulation();
            updateGraph();
            animationId = requestAnimationFrame(loop);
        }

        function renderControls() {
            const container = document.getElementById('controls-container');
            container.innerHTML = '';
            
            const addControl = (id, label, unit, min, max, step) => {
                const div = document.createElement('div');
                div.className = "group border-b border-slate-50 pb-3 last:border-0";
                div.innerHTML = `
                    <div class="flex justify-between text-[10px] font-bold mb-2 uppercase text-slate-500">
                        <span>${label}</span>
                        <span class="text-indigo-600 font-mono" id="val-${id}">${state.params[id]} ${unit}</span>
                    </div>
                    <input type="range" min="${min}" max="${max}" step="${step}" value="${state.params[id]}" 
                           class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                           oninput="updateParam('${id}', this.value, '${unit}')">
                `;
                container.appendChild(div);
            };

            if(state.activeTab === 'pendulum') {
                addControl('length', 'Chiều dài dây', 'cm', 50, 250, 1);
                addControl('initAmp', 'Biên độ góc', '°', 5, 45, 1);
            } else if(state.activeTab === 'spring' || state.activeTab === 'damped') {
                addControl('kSpring', 'Độ cứng k', 'N/m', 10, 100, 1);
                addControl('mass', 'Khối lượng m', 'kg', 0.5, 3, 0.1);
                if(state.activeTab === 'damped') addControl('dampingB', 'Hệ số cản b', 'kg/s', 0.05, 2, 0.05);
            } else {
                addControl('lDriver', 'Chiều dài con lắc mẫu (Điều khiển)', 'cm', 70, 170, 1);
                addControl('dampingB', 'Lực cản môi trường', '', 0.1, 1.5, 0.1);
            }
        }

        function updateParam(id, val, unit) {
            state.params[id] = parseFloat(val);
            document.getElementById(`val-${id}`).innerText = `${val} ${unit}`;
            updateStats();
            if (!state.isRunning) {
                updateSimulation();
                updateGraph();
            } else {
                if (id === 'length' || id === 'kSpring' || id === 'mass' || id === 'lDriver') {
                    resetSim();
                    toggleRun(); // Tự động chạy lại khi đổi lDriver
                }
            }
        }

        function updateStats() {
            const { omega } = getPhysicsConstants();
            document.getElementById('val-omega').innerText = omega.toFixed(2) + " rad/s";
            document.getElementById('val-period').innerText = (2 * Math.PI / (omega || 1)).toFixed(2) + " s";
        }

        window.addEventListener('DOMContentLoaded', () => {
            switchTab('pendulum');
        });
    </script>
</body>
</html>
