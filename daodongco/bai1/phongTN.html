<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phòng Thí Nghiệm Vật Lý Ảo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        input[type=range] { accent-color: #4f46e5; height: 6px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .tab-btn { cursor: pointer; transition: all 0.2s ease; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 flex justify-between items-center z-20 shrink-0 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-500 p-2 rounded-xl text-white shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-atom text-xl"></i>
            </div>
            <div>
                <h1 class="text-sm font-black uppercase tracking-tighter">Physics Lab Pro</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Simulator v3.1</p>
            </div>
        </div>
        
        <nav class="flex bg-slate-800 p-1 rounded-2xl border border-slate-700 overflow-x-auto scrollbar-hide" id="tab-nav">
            <button onclick="switchTab('pendulum')" id="btn-pendulum" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase bg-indigo-600 text-white shadow-md whitespace-nowrap">
                <i class="fa-solid fa-sync"></i> <span>Con Lắc Đơn</span>
            </button>
            <button onclick="switchTab('spring')" id="btn-spring" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase text-slate-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-bolt"></i> <span>Lò Xo</span>
            </button>
            <button onclick="switchTab('damped')" id="btn-damped" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase text-slate-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-wind"></i> <span>Tắt Dần</span>
            </button>
            <button onclick="switchTab('forced')" id="btn-forced" class="tab-btn flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase text-slate-400 hover:text-white whitespace-nowrap">
                <i class="fa-solid fa-wave-square"></i> <span>Cưỡng Bức (So sánh)</span>
            </button>
        </nav>

        <div class="flex gap-3">
            <button id="play-pause" onclick="toggleRun()" class="px-6 h-10 rounded-xl flex items-center justify-center text-white font-bold active:scale-95 transition-all bg-emerald-500 shadow-lg shadow-emerald-500/20 hover:bg-emerald-400">
                <i class="fa-solid fa-play mr-2" id="play-icon"></i> <span id="btn-text">BẮT ĐẦU</span>
            </button>
            <button onclick="resetSim()" class="w-10 h-10 rounded-xl bg-slate-700 text-slate-300 flex items-center justify-center border border-slate-600 hover:bg-slate-600 transition-colors">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex p-4 gap-4 overflow-hidden">
        
        <!-- Left Column -->
        <div class="flex-[3] flex flex-col gap-4 overflow-hidden">
            <div class="flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden flex flex-col">
                <div class="absolute top-6 left-8 z-10">
                    <h2 class="text-2xl font-black text-slate-800" id="sim-title">Con Lắc Đơn</h2>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="text-xs font-mono font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">Thời gian: <span id="time-display">0.00</span>s</span>
                        <span class="text-xs font-mono font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">Thông số chính: <span id="val-primary-stat">0.00</span></span>
                    </div>
                </div>

                <svg width="100%" height="100%" viewBox="0 0 800 500" id="sim-svg">
                    <defs>
                        <radialGradient id="ballGrad" cx="30%" cy="30%" r="70%"><stop offset="0%" stop-color="#6366f1" /><stop offset="100%" stop-color="#312e81" /></radialGradient>
                        <radialGradient id="redGrad" cx="30%" cy="30%" r="70%"><stop offset="0%" stop-color="#fb7185" /><stop offset="100%" stop-color="#9f1239" /></radialGradient>
                        <radialGradient id="greenGrad" cx="30%" cy="30%" r="70%"><stop offset="0%" stop-color="#34d399" /><stop offset="100%" stop-color="#065f46" /></radialGradient>
                        <radialGradient id="amberGrad" cx="30%" cy="30%" r="70%"><stop offset="0%" stop-color="#fbbf24" /><stop offset="100%" stop-color="#92400e" /></radialGradient>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f1f5f9" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    <g id="sim-content" transform="translate(400, 120)"></g>
                </svg>
            </div>

            <div class="h-48 bg-slate-900 rounded-3xl p-5 shadow-xl border border-slate-800 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i class="fa-solid fa-chart-line text-indigo-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">Biểu đồ động năng & li độ</span>
                    </div>
                    <div class="flex gap-4 text-[9px] font-bold text-white/60" id="graph-legend"></div>
                </div>
                <div class="flex-1 relative bg-black/20 rounded-xl border border-white/5 overflow-hidden">
                    <svg viewBox="0 0 100 100" class="w-full h-full" preserveAspectRatio="none">
                        <line x1="0" y1="50" x2="100" y2="50" stroke="#334155" stroke-width="0.5" stroke-dasharray="2,2" />
                        <polyline id="path-1" points="" fill="none" stroke="#818cf8" stroke-width="1.2" />
                        <polyline id="path-2" points="" fill="none" stroke="#34d399" stroke-width="1.2" />
                        <polyline id="path-3" points="" fill="none" stroke="#fbbf24" stroke-width="1.2" />
                        <polyline id="path-driver" points="" fill="none" stroke="#fb7185" stroke-width="0.8" stroke-dasharray="1,1" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <aside class="w-80 flex flex-col gap-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                <div class="flex items-center gap-2 text-slate-400 mb-6 shrink-0">
                    <i class="fa-solid fa-sliders text-indigo-500"></i>
                    <h3 class="text-xs font-black uppercase tracking-widest">Cấu hình</h3>
                </div>

                <div id="controls-container" class="space-y-8 flex-1 overflow-y-auto pr-2 scrollbar-hide"></div>
            </div>
            
            <div class="bg-indigo-600 p-5 rounded-3xl text-white shadow-lg shadow-indigo-600/20">
                <h4 class="text-[10px] font-black uppercase mb-2 opacity-80">Hướng dẫn</h4>
                <p class="text-xs leading-relaxed font-medium" id="tip-text"></p>
            </div>
        </aside>
    </main>

    <script>
        const state = {
            activeTab: 'pendulum',
            isRunning: false,
            time: 0,
            history: [],
            params: {
                length: 200,    // L
                gravity: 9.8,   // g
                kSpring: 30,    // k
                mass: 1.0,      // m
                mu: 0.1,        // hệ số ma sát
                lDriver: 150    // Chiều dài con lắc mẫu
            }
        };

        const MAX_HISTORY = 400;
        let lastTime = 0;
        let animationId = null;

        function switchTab(tab) {
            state.activeTab = tab;
            state.isRunning = false;
            state.time = 0;
            state.history = [];
            if (animationId) cancelAnimationFrame(animationId);
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
            activeBtn.classList.remove('text-slate-400');
            
            document.getElementById('sim-title').innerText = activeBtn.querySelector('span').innerText;
            renderControls();
            updateUIState();
            updateSimulation();
            updateStats();
            updateGraph();
        }

        function renderControls() {
            const container = document.getElementById('controls-container');
            const tip = document.getElementById('tip-text');
            const legend = document.getElementById('graph-legend');
            container.innerHTML = '';
            
            let controls = [];
            switch(state.activeTab) {
                case 'pendulum':
                    controls = [
                        { id: 'length', label: 'Chiều dài (L)', unit: 'cm', min: 100, max: 300, step: 1 },
                        { id: 'gravity', label: 'Gia tốc (g)', unit: 'm/s²', min: 1, max: 20, step: 0.1 }
                    ];
                    tip.innerText = "Thay đổi L hoặc g để thấy sự thay đổi của chu kỳ dao động T.";
                    legend.innerHTML = `<span class="text-indigo-400">● Li độ x</span>`;
                    break;
                case 'spring':
                    controls = [
                        { id: 'kSpring', label: 'Độ cứng (k)', unit: 'N/m', min: 10, max: 100, step: 1 },
                        { id: 'mass', label: 'Khối lượng (m)', unit: 'kg', min: 0.5, max: 5, step: 0.1 }
                    ];
                    tip.innerText = "Dao động điều hòa của vật nặng gắn trên lò xo.";
                    legend.innerHTML = `<span class="text-indigo-400">● Li độ x</span>`;
                    break;
                case 'damped':
                    controls = [
                        { id: 'kSpring', label: 'Độ cứng (k)', unit: 'N/m', min: 20, max: 80, step: 1 },
                        { id: 'mass', label: 'Khối lượng (m)', unit: 'kg', min: 1, max: 5, step: 0.1 },
                        { id: 'mu', label: 'Hệ số ma sát (μ)', unit: '', min: 0, max: 1.5, step: 0.05 }
                    ];
                    tip.innerText = "Ma sát làm tiêu hao cơ năng, biên độ giảm dần theo thời gian.";
                    legend.innerHTML = `<span class="text-indigo-400">● Li độ x</span> <span class="text-slate-400">--- Biên độ A(t)</span>`;
                    break;
                case 'forced':
                    controls = [
                        { id: 'lDriver', label: 'Chiều dài mẫu (L_m)', unit: 'cm', min: 120, max: 280, step: 1 },
                        { id: 'mu', label: 'Lực cản môi trường', unit: '', min: 0.05, max: 0.4, step: 0.01 }
                    ];
                    tip.innerText = "So sánh 3 con lắc: 150cm (Tím), 200cm (Xanh), 250cm (Vàng). Con lắc nào có chiều dài gần với vật mẫu nhất sẽ dao động mạnh nhất (Cộng hưởng).";
                    legend.innerHTML = `<span class="text-indigo-400">● 150cm</span> <span class="text-emerald-400">● 200cm</span> <span class="text-amber-400">● 250cm</span> <span class="text-rose-400">-- Mẫu</span>`;
                    break;
            }

            controls.forEach(c => {
                const div = document.createElement('div');
                div.className = "space-y-3";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-black uppercase text-slate-500 tracking-tight">${c.label}</label>
                        <span class="bg-slate-100 text-indigo-700 px-2 py-0.5 rounded font-mono font-bold text-xs" id="val-${c.id}">${state.params[c.id]} ${c.unit}</span>
                    </div>
                    <input type="range" min="${c.min}" max="${c.max}" step="${c.step}" value="${state.params[c.id]}" class="w-full cursor-pointer" oninput="updateParam('${c.id}', this.value, '${c.unit}')">
                `;
                container.appendChild(div);
            });
        }

        function updateParam(id, val, unit) {
            state.params[id] = parseFloat(val);
            document.getElementById(`val-${id}`).innerText = `${val} ${unit}`;
            updateStats();
            if (state.activeTab !== 'forced' || id === 'lDriver') resetSim();
        }

        function toggleRun() {
            state.isRunning = !state.isRunning;
            updateUIState();
            if(state.isRunning) { lastTime = performance.now(); animationId = requestAnimationFrame(loop); }
        }

        function updateUIState() {
            const icon = document.getElementById('play-icon');
            const txt = document.getElementById('btn-text');
            const btn = document.getElementById('play-pause');
            if(state.isRunning) {
                btn.classList.replace('bg-emerald-500', 'bg-rose-500');
                icon.className = "fa-solid fa-pause mr-2";
                txt.innerText = "TẠM DỪNG";
            } else {
                btn.classList.replace('bg-rose-500', 'bg-emerald-500');
                icon.className = "fa-solid fa-play mr-2";
                txt.innerText = "BẮT ĐẦU";
            }
        }

        function resetSim() {
            state.time = 0; state.history = []; state.isRunning = false;
            updateUIState(); updateSimulation(); updateGraph();
            document.getElementById('time-display').innerText = "0.00";
        }

        function updateStats() {
            let label = "Tần số góc (ω)";
            let val = 0;
            const p = state.params;

            if (state.activeTab === 'pendulum') val = Math.sqrt(p.gravity / (p.length / 100));
            else if (state.activeTab === 'spring' || state.activeTab === 'damped') val = Math.sqrt(p.kSpring / p.mass);
            else if (state.activeTab === 'forced') {
                label = "Tần số mẫu (rad/s)";
                val = Math.sqrt(p.gravity / (p.lDriver / 100));
            }
            document.getElementById('val-primary-stat').innerText = val.toFixed(2);
        }

        function calculatePhysics(t) {
            const p = state.params;
            let results = { x1: 0, x2: 0, x3: 0, env: 0, driver: 0 };

            if (state.activeTab === 'pendulum') {
                const omega = Math.sqrt(p.gravity / (p.length / 100));
                results.x1 = 0.5 * Math.cos(omega * t);
            } else if (state.activeTab === 'spring') {
                const omega = Math.sqrt(p.kSpring / p.mass);
                results.x1 = 60 * Math.cos(omega * t);
            } else if (state.activeTab === 'damped') {
                const omega0 = Math.sqrt(p.kSpring / p.mass);
                const beta = p.mu / (2 * p.mass);
                const omegaD = Math.sqrt(Math.max(0, omega0**2 - beta**2));
                results.env = 60 * Math.exp(-beta * t);
                results.x1 = results.env * Math.cos(omegaD * t);
            } else if (state.activeTab === 'forced') {
                const wd = Math.sqrt(p.gravity / (p.lDriver / 100));
                const beta = p.mu; // Lực cản môi trường
                const F0 = 0.12; 

                // Tính toán cho 3 con lắc so sánh (150cm, 200cm, 250cm)
                [150, 200, 250].forEach((L, i) => {
                    const w0 = Math.sqrt(p.gravity / (L / 100));
                    const denom = Math.sqrt(Math.pow(w0**2 - wd**2, 2) + Math.pow(2 * beta * wd, 2));
                    const A_stable = F0 / (denom || 0.001);
                    const currentAmp = A_stable * (1 - Math.exp(-beta * t * 1.5)); // Biên độ tăng dần rồi ổn định
                    results[`x${i+1}`] = currentAmp * Math.sin(wd * t);
                });
                results.driver = 0.2 * Math.sin(wd * t); // Góc lệch con lắc mẫu
            }
            return results;
        }

        function updateSimulation() {
            const data = calculatePhysics(state.time);
            const sim = document.getElementById('sim-content');
            const p = state.params;

            if (state.activeTab === 'pendulum') {
                const ang = data.x1 * 180 / Math.PI;
                sim.innerHTML = `
                    <line x1="-100" y1="0" x2="100" y2="0" stroke="#1e293b" stroke-width="8"/>
                    <g transform="rotate(${ang})">
                        <line y2="${p.length}" stroke="#64748b" stroke-width="2"/>
                        <circle cy="${p.length}" r="20" fill="url(#ballGrad)"/>
                    </g>`;
            } else if (state.activeTab === 'spring' || state.activeTab === 'damped') {
                const y = data.x1 + 140;
                let path = "M 0 0";
                for(let i=0; i<=20; i++) path += ` L ${i==0||i==20?0:(i%2?15:-15)} ${(i/20)*y}`;
                sim.innerHTML = `
                    <line x1="-50" x2="50" stroke="#1e293b" stroke-width="8"/>
                    <path d="${path}" fill="none" stroke="#94a3b8" stroke-width="2"/>
                    <rect x="-30" y="${y}" width="60" height="40" rx="8" fill="url(#ballGrad)"/>`;
            } else if (state.activeTab === 'forced') {
                let h = `<line x1="-250" x2="250" stroke="#1e293b" stroke-width="6"/>`;
                // Vẽ con lắc mẫu (Đỏ)
                h += `<g transform="translate(-180,0) rotate(${data.driver*180/Math.PI})">
                        <line y2="${p.lDriver}" stroke="#fb7185" stroke-width="3"/>
                        <circle cy="${p.lDriver}" r="12" fill="url(#redGrad)"/>
                        <text y="-10" text-anchor="middle" fill="#fb7185" font-size="10" font-weight="bold">MẪU</text>
                      </g>`;
                // Vẽ 3 con lắc so sánh
                const colors = ['#818cf8', '#34d399', '#fbbf24'];
                const grads = ['ballGrad', 'greenGrad', 'amberGrad'];
                const lens = [150, 200, 250];
                
                lens.forEach((L, i) => {
                    const ang = data[`x${i+1}`] * 180 / Math.PI;
                    h += `<g transform="translate(${-40 + i*100}, 0) rotate(${ang})">
                            <line y2="${L}" stroke="#94a3b8" stroke-width="1.5"/>
                            <circle cy="${L}" r="${10 + i*2}" fill="url(#${grads[i]})"/>
                            <text y="${L+25}" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">${L}cm</text>
                          </g>`;
                });
                sim.innerHTML = h;
            }
        }

        function updateGraph() {
            if (!state.history.length) return;
            const p1 = document.getElementById('path-1');
            const p2 = document.getElementById('path-2');
            const p3 = document.getElementById('path-3');
            const pd = document.getElementById('path-driver');
            
            const mapY = (val, scale = 40) => 50 - val * scale;

            if (state.activeTab === 'forced') {
                const s = 35;
                p1.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.x1, s)}`).join(' '));
                p2.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.x2, s)}`).join(' '));
                p3.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.x3, s)}`).join(' '));
                pd.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.driver, s)}`).join(' '));
                pd.style.display = 'block';
            } else if (state.activeTab === 'damped') {
                p1.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.x1, 0.6)}`).join(' '));
                p2.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.env, 0.6)}`).join(' '));
                p2.setAttribute('stroke-dasharray', "2,2");
                p3.setAttribute('points', "");
                pd.style.display = 'none';
            } else {
                const scale = state.activeTab === 'pendulum' ? 60 : 0.6;
                p1.setAttribute('points', state.history.map((d, i) => `${(i/MAX_HISTORY)*100},${mapY(d.x1, scale)}`).join(' '));
                p2.setAttribute('points', "");
                p3.setAttribute('points', "");
                pd.style.display = 'none';
            }
        }

        function loop(timestamp) {
            if (!state.isRunning) return;
            const dt = Math.min((timestamp - lastTime)/1000, 0.03);
            state.time += dt;
            lastTime = timestamp;

            const data = calculatePhysics(state.time);
            state.history.push(data);
            if(state.history.length > MAX_HISTORY) state.history.shift();

            document.getElementById('time-display').innerText = state.time.toFixed(2);
            updateSimulation();
            updateGraph();
            animationId = requestAnimationFrame(loop);
        }

        window.onload = () => switchTab('pendulum');
    </script>
</body>
</html>
