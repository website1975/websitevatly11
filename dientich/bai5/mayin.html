<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Máy in Tĩnh điện (Dành cho Học sinh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f0f4f8;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .panel-container {
            height: calc(100vh - 100px);
            min-height: 550px;
        }
        .canvas-area {
            position: relative;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #printCanvas {
            max-width: 100%;
            max-height: 100%;
        }
        .comment-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .step-active {
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Tùy chỉnh thanh cuộn cho khu vực nhận xét */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="p-4 md:p-6 overflow-hidden">
    <div class="max-w-[1400px] mx-auto h-full">
        <header class="mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-slate-800">Phòng Thí Nghiệm Vật Lý Ảo</h1>
                <p class="text-slate-500 text-xs italic">Chủ đề: Nguyên lý máy in tĩnh điện (Xerography)</p>
            </div>
            <div id="status" class="text-[10px] font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-600 uppercase tracking-tighter">
                Sẵn sàng
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 panel-container">
            <!-- PANEL 1: NHẬN XÉT & NGUYÊN LÝ (CỨNG) -->
            <div class="lg:col-span-4 flex flex-col gap-4 overflow-hidden">
                
                <!-- Khu vực điều khiển -->
                <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 shrink-0">
                    <label class="block mb-3 text-sm font-bold text-slate-700">1. Chọn ký tự để thí nghiệm:</label>
                    <div class="flex gap-2 mb-4">
                        <button onclick="setLetter('A')" class="flex-1 py-2 bg-slate-50 hover:bg-blue-500 hover:text-white rounded-lg border border-slate-200 transition-all font-bold">A</button>
                        <button onclick="setLetter('G')" class="flex-1 py-2 bg-slate-50 hover:bg-blue-500 hover:text-white rounded-lg border border-slate-200 transition-all font-bold">G</button>
                        <button onclick="setLetter('Ω')" class="flex-1 py-2 bg-slate-50 hover:bg-blue-500 hover:text-white rounded-lg border border-slate-200 transition-all font-bold">Ω</button>
                        <input type="text" id="customChar" maxlength="1" placeholder="?" 
                            class="w-12 border-2 border-dashed border-slate-300 rounded-lg text-center font-bold focus:border-blue-500 outline-none"
                            oninput="setLetter(this.value)">
                    </div>
                    
                    <button id="btnStart" onclick="startProcess()" 
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md transition-all flex items-center justify-center gap-2">
                        BẮT ĐẦU THÍ NGHIỆM
                    </button>
                </section>

                <!-- Khu vực Nhận xét và Nguyên lý (Lập trình sẵn) -->
                <section class="bg-white p-5 rounded-2xl shadow-sm flex-grow border border-slate-200 overflow-hidden flex flex-col">
                    <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide mb-4 flex items-center gap-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Nguyên lý & Nhận xét
                    </h2>
                    
                    <!-- Container có thanh cuộn -->
                    <div id="aiContentScroll" class="flex-grow overflow-y-auto custom-scrollbar pr-1 space-y-3">
                        <div id="info-init" class="p-3 rounded-lg bg-blue-50 text-blue-800 text-xs leading-relaxed">
                            Chào các em! Hãy chọn một ký tự và nhấn nút để bắt đầu thí nghiệm. Chúng ta sẽ cùng tìm hiểu cách dòng điện và ánh sáng tạo nên một bản in.
                        </div>
                        
                        <!-- Các nội dung này sẽ hiện ra theo từng bước -->
                        <div id="info-step-1" class="hidden p-3 rounded-lg comment-box text-xs">
                            <b class="text-blue-600 block mb-1 underline">Bước 1: Tích điện</b>
                            Bề mặt trống được phủ một lớp quang dẫn. Thiết bị tích điện sẽ phun các ion dương để làm cho toàn bộ bề mặt trống mang điện tích dương đồng nhất.
                        </div>

                        <div id="info-step-2" class="hidden p-3 rounded-lg comment-box text-xs">
                            <b class="text-blue-600 block mb-1 underline">Bước 2: Phơi sáng</b>
                            Tia Laser quét lên trống theo hình dạng ký tự. Những nơi bị ánh sáng chiếu vào sẽ trở nên dẫn điện và điện tích dương ở đó bị triệt tiêu, tạo thành "ảnh ẩn" bằng điện tích.
                        </div>

                        <div id="info-step-3" class="hidden p-3 rounded-lg comment-box text-xs">
                            <b class="text-blue-600 block mb-1 underline">Bước 3: Hiện ảnh (Hút mực)</b>
                            Hạt mực (toner) mang điện tích âm được đưa sát vào trống. Do lực hút tĩnh điện giữa các điện tích trái dấu, mực âm sẽ bám chặt vào vùng ảnh ẩn mang điện dương.
                        </div>

                        <div id="info-step-4" class="hidden p-3 rounded-lg comment-box text-xs">
                            <b class="text-blue-600 block mb-1 underline">Bước 4: Ép nhiệt</b>
                            Giấy được đưa qua và nhận mực từ trống. Sau đó, một trục ép nhiệt sẽ làm mực nóng chảy và bám vĩnh viễn vào sợi giấy. Thí nghiệm hoàn tất!
                        </div>
                    </div>
                </section>
            </div>

            <!-- PANEL 2: MÔ PHỎNG -->
            <div class="lg:col-span-8 flex flex-col">
                <div class="canvas-area flex-grow border border-slate-200">
                    <div id="stepLabel" class="absolute top-6 left-6 bg-white/90 border border-slate-200 px-4 py-2 rounded-lg text-[10px] font-bold text-slate-600 uppercase z-10 shadow-sm">
                        Đang chờ...
                    </div>
                    <canvas id="printCanvas"></canvas>
                </div>
                
                <div class="mt-4 flex gap-4 text-[10px] font-medium text-slate-500 bg-white p-3 rounded-xl border border-slate-200">
                    <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 bg-blue-500 rounded-full"></span> Điện tích dương (+)</div>
                    <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 bg-slate-700 rounded-full"></span> Hạt mực âm (-)</div>
                    <div class="flex items-center gap-1.5"><span class="w-4 h-0.5 bg-red-500"></span> Tia Laser</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('printCanvas');
        const ctx = canvas.getContext('2d');
        const stepLabel = document.getElementById('stepLabel');
        const statusDiv = document.getElementById('status');
        const scrollContainer = document.getElementById('aiContentScroll');
        
        let width, height, currentLetter = 'A', step = 0, particles = [], letterMask = []; 

        function initCanvas() {
            const container = canvas.parentElement;
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;
            drawStatic();
        }

        window.onload = initCanvas;
        window.onresize = initCanvas;

        function setLetter(l) {
            if (!l) return;
            currentLetter = l.toUpperCase().substring(0,1);
            resetSim();
        }

        function drawStatic() {
            ctx.clearRect(0, 0, width, height);
            const p = 60;
            ctx.fillStyle = "#f8fafc";
            ctx.beginPath();
            ctx.roundRect(p, p, width - p*2, height - p*2, 20);
            ctx.fill();
            ctx.strokeStyle = "#e2e8f0";
            ctx.stroke();
        }

        function showInfo(stepNum) {
            // Ẩn lời chào ban đầu
            document.getElementById('info-init').classList.add('hidden');
            // Hiển thị nội dung bước tương ứng
            const infoEl = document.getElementById(`info-step-${stepNum}`);
            if (infoEl) {
                infoEl.classList.remove('hidden');
                infoEl.classList.add('step-active');
                // Tự động cuộn xuống dưới cùng để thấy nội dung mới nhất
                setTimeout(() => {
                    scrollContainer.scrollTo({
                        top: scrollContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        async function startProcess() {
            if (step > 0 && step < 4) return;
            resetSim();
            document.getElementById('btnStart').disabled = true;
            
            // Bước 1
            step = 1; updateUI("Tích điện"); 
            showInfo(1);
            await runStep1();
            
            // Bước 2
            step = 2; updateUI("Phơi sáng"); 
            showInfo(2);
            await runStep2();
            
            // Bước 3
            step = 3; updateUI("Hút mực"); 
            showInfo(3);
            await runStep3();
            
            // Bước 4
            step = 4; updateUI("Ép nhiệt"); 
            showInfo(4);
            await runStep4();

            document.getElementById('btnStart').disabled = false;
            statusDiv.innerText = "Hoàn tất";
        }

        function updateUI(text) {
            stepLabel.innerText = text;
            statusDiv.innerText = "Đang chạy...";
        }

        function resetSim() {
            step = 0; particles = []; letterMask = [];
            stepLabel.innerText = "Đang chờ...";
            statusDiv.innerText = "Sẵn sàng";
            document.getElementById('info-init').classList.remove('hidden');
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`info-step-${i}`);
                el.classList.add('hidden');
                el.classList.remove('step-active');
            }
            scrollContainer.scrollTop = 0;
            drawStatic();
        }

        // --- Logic mô phỏng vật lý ---

        async function runStep1() {
            const p = 60;
            for (let i = 0; i < 8; i++) {
                ctx.fillStyle = "#3b82f6";
                ctx.font = "12px sans-serif";
                for(let j=0; j<10; j++) {
                    ctx.fillText("+", p+20 + Math.random()*(width-p*2-40), p+20 + Math.random()*(height-p*2-40));
                }
                await new Promise(r => setTimeout(r, 60));
            }
        }

        async function runStep2() {
            const p = 60;
            const offCanvas = document.createElement('canvas');
            offCanvas.width = width; offCanvas.height = height;
            const octx = offCanvas.getContext('2d');
            octx.font = `bold ${height*0.6}px sans-serif`;
            octx.textAlign = "center"; octx.textBaseline = "middle";
            octx.fillText(currentLetter, width/2, height/2);
            const data = octx.getImageData(0,0,width,height).data;
            for(let i=0; i<data.length; i+=4*10) { 
                if(data[i+3] > 128) {
                    const idx = i/4;
                    letterMask.push({x: idx % width, y: Math.floor(idx / width)});
                }
            }
            for (let x = p; x < width - p; x += 30) {
                drawStatic();
                ctx.fillStyle = "#2563eb";
                ctx.font = `bold ${height*0.6}px sans-serif`;
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.save();
                ctx.beginPath(); ctx.rect(p, p, x - p, height - p*2); ctx.clip();
                ctx.fillText(currentLetter, width/2, height/2);
                ctx.restore();
                ctx.strokeStyle = "red";
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
                await new Promise(r => setTimeout(r, 40));
            }
        }

        async function runStep3() {
            if(letterMask.length === 0) return;
            for(let i=0; i<800; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() > 0.5 ? -30 : height + 30,
                    target: letterMask[Math.floor(Math.random() * letterMask.length)],
                    size: 2, speed: 4 + Math.random() * 8
                });
            }
            return new Promise(resolve => {
                let frames = 0;
                function animate() {
                    frames++;
                    let moving = false;
                    ctx.clearRect(0,0,width,height);
                    drawStatic();
                    ctx.fillStyle = "#334155";
                    particles.forEach(p => {
                        const dx = p.target.x - p.x; const dy = p.target.y - p.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if(dist > 2) {
                            p.x += (dx/dist)*p.speed; p.y += (dy/dist)*p.speed;
                            moving = true;
                        }
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                    });
                    if(moving && frames < 180) requestAnimationFrame(animate);
                    else resolve();
                }
                animate();
            });
        }

        async function runStep4() {
            const p = 60;
            for (let h = 0; h < height - p*2; h += 40) {
                drawStatic();
                ctx.fillStyle = "#334155";
                particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.fillRect(p+10, p, width-p*2-20, h);
                await new Promise(r => setTimeout(r, 30));
            }
            ctx.fillStyle = "white"; ctx.fillRect(0,0,width,height);
            ctx.fillStyle = "black"; ctx.font = `bold ${height*0.6}px sans-serif`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(currentLetter, width/2, height/2);
        }
    </script>
</body>
</html>