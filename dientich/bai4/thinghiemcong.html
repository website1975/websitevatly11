<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Công Lực Điện Trường</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
    </script>
    <style>
        body {
            background-color: #f8fafc;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 10px;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .main-container {
            width: 100%;
            max-width: 1100px;
            height: 90vh; /* Giới hạn chiều cao tối đa */
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: row;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        canvas { touch-action: none; width: 100%; height: 100%; }
        .active-tab { background-color: #1e293b !important; color: white !important; }
        .hidden-view { display: none !important; }
        input[type=range] { height: 4px; }
        .panel-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <!-- Left Panel: Controls & Analysis -->
        <div class="w-72 md:w-80 bg-slate-50 border-r border-slate-200 flex flex-col h-full">
            <!-- Tab Headers (Thấp hơn) -->
            <div class="flex border-b border-slate-200 bg-white">
                <button onclick="switchView('controls')" id="tab-controls" class="flex-1 py-2 text-xs font-bold uppercase active-tab">Điều khiển</button>
                <button onclick="switchView('analysis')" id="tab-analysis" class="flex-1 py-2 text-xs font-bold uppercase bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">Nhận xét</button>
            </div>

            <!-- Content Area (Sử dụng flex-1 và panel-scroll) -->
            <div class="p-4 panel-scroll flex-1">
                
                <!-- VIEW 1: CONTROLS -->
                <div id="view-controls" class="space-y-4">
                    <!-- Trajectory -->
                    <div>
                        <label class="block text-[11px] font-bold text-slate-600 mb-1 uppercase">Quỹ Đạo</label>
                        <div class="grid grid-cols-1 gap-1">
                            <button onclick="setPathType('straight')" id="btn-straight" class="path-btn active-tab border border-slate-300 py-1.5 px-3 rounded text-[11px] text-left">1. Thẳng</button>
                            <button onclick="setPathType('curved')" id="btn-curved" class="path-btn bg-white border border-slate-300 py-1.5 px-3 rounded text-[11px] text-left hover:bg-slate-50">2. Cong (Parabol)</button>
                            <button onclick="setPathType('random')" id="btn-random" class="path-btn bg-white border border-slate-300 py-1.5 px-3 rounded text-[11px] text-left hover:bg-slate-50">3. Tuỳ ý (Zic-zac)</button>
                        </div>
                    </div>

                    <!-- Sliders (Gom gọn lại) -->
                    <div class="space-y-3 pt-2 border-t border-slate-200">
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-[11px] font-bold text-slate-600">Điện tích $q$</label><span id="chargeVal" class="text-[11px] font-bold text-blue-600">5 μC</span></div>
                            <input type="range" id="chargeInput" min="-10" max="10" step="1" value="5" class="w-full bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-[11px] font-bold text-slate-600">Cường độ $E$</label><span id="fieldVal" class="text-[11px] font-bold text-red-600">500 V/m</span></div>
                            <input type="range" id="fieldInput" min="100" max="2000" step="100" value="500" class="w-full bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <!-- Values Box (Nhỏ gọn hơn) -->
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <div class="grid grid-cols-2 gap-2 text-[11px]">
                            <div>
                                <span class="block text-slate-500">Hình chiếu $d$:</span>
                                <span id="d_val" class="font-bold text-indigo-700">0 m</span>
                            </div>
                            <div>
                                <span class="block text-slate-500">Công thực hiện $A$:</span>
                                <span id="workVal" class="font-bold text-green-600">0 mJ</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="startMoveBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-xs font-bold transition-colors disabled:opacity-50">Bắt đầu</button>
                        <button id="resetPointsBtn" class="flex-1 bg-slate-700 hover:bg-slate-800 text-white py-2 rounded text-xs font-bold transition-colors">Chọn lại</button>
                    </div>
                </div>

                <!-- VIEW 2: ANALYSIS (NHẬN XÉT - GỌN GÀNG) -->
                <div id="view-analysis" class="hidden-view space-y-3">
                    <div class="text-[11px] space-y-3 text-slate-700">
                        <section class="bg-white p-2 rounded border border-slate-200">
                            <h4 class="font-bold text-blue-800 mb-1">1. Công thức</h4>
                            <p class="italic text-center bg-slate-50 py-1 rounded">$A = q \cdot E \cdot d$</p>
                        </section>
                        
                        <section class="bg-white p-2 rounded border border-slate-200">
                            <h4 class="font-bold text-blue-800 mb-1">2. Hình dáng đường đi</h4>
                            <p class="leading-tight">Công <b>không phụ thuộc</b> vào hình dáng đường đi, chỉ phụ thuộc vị trí điểm đầu A và điểm cuối B.</p>
                        </section>

                        <section class="bg-white p-2 rounded border border-slate-200">
                            <h4 class="font-bold text-blue-800 mb-1">3. Dấu của công $A$</h4>
                            <table class="w-full border-collapse text-[10px]">
                                <tr class="bg-slate-100 text-center font-bold">
                                    <td class="border border-slate-300 p-1">Hướng</td>
                                    <td class="border border-slate-300 p-1">q > 0</td>
                                    <td class="border border-slate-300 p-1">q < 0</td>
                                </tr>
                                <tr>
                                    <td class="border border-slate-300 p-1">Cùng $\vec{E}$</td>
                                    <td class="border border-slate-300 p-1 text-green-600 font-bold">A > 0</td>
                                    <td class="border border-slate-300 p-1 text-red-600 font-bold">A < 0</td>
                                </tr>
                                <tr>
                                    <td class="border border-slate-300 p-1">Ngược $\vec{E}$</td>
                                    <td class="border border-slate-300 p-1 text-red-600 font-bold">A < 0</td>
                                    <td class="border border-slate-300 p-1 text-green-600 font-bold">A > 0</td>
                                </tr>
                            </table>
                        </section>
                    </div>
                </div>
            </div>
            
            <!-- Instructions (Gom thành 1 dòng) -->
            <div class="p-2 text-[10px] text-slate-500 bg-amber-50 border-t border-amber-100 italic">
                Click chuột lên màn hình để chọn A và B.
            </div>
        </div>

        <!-- Right Panel: Simulation (Canvas chiếm đa số diện tích) -->
        <div class="flex-1 relative flex flex-col bg-white">
            <div class="px-4 py-2 bg-white border-b flex justify-between items-center shadow-sm">
                <div>
                    <h1 class="text-xs font-bold text-slate-700 uppercase tracking-tight">Thí nghiệm Công Lực Điện</h1>
                    <span id="statusText" class="text-[10px] text-blue-500 font-medium italic">Click chọn điểm A</span>
                </div>
                <div class="flex gap-3">
                    <div class="flex items-center gap-1"><span class="w-2 h-2 bg-red-500 rounded-full"></span> <span class="text-[10px]">(+)</span></div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-500 rounded-full"></span> <span class="text-[10px]">(-)</span></div>
                </div>
            </div>
            
            <div id="canvasContainer" class="flex-1 relative overflow-hidden bg-slate-50">
                <canvas id="simCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');

        let q = 5e-6; 
        let fieldStrength = 500;
        let posA = null, posB = null, currentPos = null;
        let pathType = 'straight'; 
        let isMoving = false, progress = 0; 
        
        const chargeInput = document.getElementById('chargeInput');
        const fieldInput = document.getElementById('fieldInput');
        const chargeVal = document.getElementById('chargeVal');
        const fieldVal = document.getElementById('fieldVal');
        const workVal = document.getElementById('workVal');
        const dVal = document.getElementById('d_val');
        const statusText = document.getElementById('statusText');
        const startMoveBtn = document.getElementById('startMoveBtn');

        const PADDING = 50;
        const SCALE_M = 0.001; 

        function init() {
            resize();
            window.addEventListener('resize', resize);
            canvas.addEventListener('mousedown', handleCanvasClick);
            
            chargeInput.addEventListener('input', (e) => {
                q = parseFloat(e.target.value) * 1e-6;
                chargeVal.innerText = e.target.value + ' μC';
                updateCalculations();
            });

            fieldInput.addEventListener('input', (e) => {
                fieldStrength = parseFloat(e.target.value);
                fieldVal.innerText = e.target.value + ' V/m';
                updateCalculations();
            });

            startMoveBtn.addEventListener('click', () => {
                if (!posA || !posB || isMoving) return;
                isMoving = true; progress = 0;
                statusText.innerText = "Đang chạy...";
                checkButtons();
            });

            document.getElementById('resetPointsBtn').addEventListener('click', () => {
                isMoving = false; posA = null; posB = null; currentPos = null;
                statusText.innerText = "Chọn điểm A";
                checkButtons(); updateCalculations();
            });

            updateCalculations();
            animate();
            checkButtons();
        }

        function switchView(view) {
            document.getElementById('view-controls').classList.toggle('hidden-view', view !== 'controls');
            document.getElementById('view-analysis').classList.toggle('hidden-view', view !== 'analysis');
            document.getElementById('tab-controls').className = `flex-1 py-2 text-xs font-bold uppercase ${view === 'controls' ? 'active-tab' : 'bg-slate-100 text-slate-500'}`;
            document.getElementById('tab-analysis').className = `flex-1 py-2 text-xs font-bold uppercase ${view === 'analysis' ? 'active-tab' : 'bg-slate-100 text-slate-500'}`;
        }

        function setPathType(type) {
            if (isMoving) return;
            pathType = type;
            document.querySelectorAll('.path-btn').forEach(btn => btn.className = 'path-btn bg-white border border-slate-300 py-1.5 px-3 rounded text-[11px] text-left hover:bg-slate-50');
            document.getElementById(`btn-${type}`).className = 'path-btn active-tab border border-slate-300 py-1.5 px-3 rounded text-[11px] text-left';
        }

        function handleCanvasClick(e) {
            if (isMoving) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            if (x < PADDING || x > canvas.width - PADDING) return;

            if (!posA) {
                posA = { x, y }; currentPos = { x, y };
                statusText.innerText = "Chọn điểm B";
            } else if (!posB) {
                posB = { x, y };
                statusText.innerText = "Bấm 'Bắt đầu'";
            } else {
                posA = { x, y }; posB = null; currentPos = { x, y };
                statusText.innerText = "Chọn lại điểm B";
            }
            checkButtons(); updateCalculations();
        }

        function checkButtons() {
            startMoveBtn.disabled = (!posA || !posB || isMoving);
        }

        function getPositionAt(t) {
            if (!posA || !posB) return null;
            const dx = posB.x - posA.x, dy = posB.y - posA.y;
            if (pathType === 'straight') return { x: posA.x + dx * t, y: posA.y + dy * t };
            if (pathType === 'curved') {
                const midX = (posA.x + posB.x) / 2, midY = (posA.y + posB.y) / 2 - 80;
                const q1x = posA.x + (midX - posA.x) * t, q1y = posA.y + (midY - posA.y) * t;
                const q2x = midX + (posB.x - midX) * t, q2y = midY + (posB.y - midY) * t;
                return { x: q1x + (q2x - q1x) * t, y: q1y + (q2y - q1y) * t };
            }
            const freq = 2, amp = 40;
            const offsetX = Math.sin(t * Math.PI * freq) * amp * (1 - Math.abs(0.5 - t) * 2);
            return { x: posA.x + dx * t + offsetX, y: posA.y + dy * t };
        }

        function updateCalculations() {
            if (!posA || !currentPos) {
                dVal.innerText = "0 m"; workVal.innerText = "0 mJ"; return;
            }
            const d_m = (currentPos.x - posA.x) * SCALE_M;
            const work = q * fieldStrength * d_m;
            dVal.innerText = d_m.toFixed(3) + ' m';
            workVal.innerText = (work * 1000).toFixed(3) + ' mJ';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Plates
            ctx.fillStyle = '#fee2e2'; ctx.fillRect(0, 0, PADDING, canvas.height);
            ctx.fillStyle = '#ef4444'; ctx.fillRect(PADDING-3, 0, 3, canvas.height);
            ctx.fillStyle = '#dbeafe'; ctx.fillRect(canvas.width-PADDING, 0, PADDING, canvas.height);
            ctx.fillStyle = '#3b82f6'; ctx.fillRect(canvas.width-PADDING, 0, 3, canvas.height);

            // Field arrows
            ctx.strokeStyle = 'rgba(239,68,68,0.08)';
            for (let y = 20; y < canvas.height; y += 30) {
                ctx.beginPath(); ctx.moveTo(PADDING+5, y); ctx.lineTo(canvas.width-PADDING-5, y); ctx.stroke();
            }

            if (posA && posB) {
                ctx.beginPath(); ctx.setLineDash([4, 4]); ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
                for (let t = 0; t <= 1; t += 0.02) {
                    const p = getPositionAt(t);
                    if (t === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                }
                ctx.stroke(); ctx.setLineDash([]);
            }

            if (posA) {
                ctx.fillStyle = '#334155'; ctx.beginPath(); ctx.arc(posA.x, posA.y, 3, 0, 7); ctx.fill();
                ctx.font = '10px Arial'; ctx.fillText('A', posA.x, posA.y - 8);
                ctx.setLineDash([2, 2]); ctx.strokeStyle = '#cbd5e1';
                ctx.beginPath(); ctx.moveTo(posA.x, posA.y); ctx.lineTo(posA.x, canvas.height - 30); ctx.stroke();
            }

            if (posB) {
                ctx.fillStyle = '#334155'; ctx.beginPath(); ctx.arc(posB.x, posB.y, 3, 0, 7); ctx.fill();
                ctx.fillText('B', posB.x, posB.y - 8);
            }

            if (currentPos) {
                const color = q > 0 ? '#ef4444' : (q < 0 ? '#3b82f6' : '#94a3b8');
                ctx.fillStyle = color; ctx.beginPath(); ctx.arc(currentPos.x, currentPos.y, 8, 0, 7); ctx.fill();
                ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText(q > 0 ? '+' : '-', currentPos.x, currentPos.y + 3);
                
                const axisY = canvas.height - 30;
                ctx.setLineDash([2, 2]); ctx.strokeStyle = color;
                ctx.beginPath(); ctx.moveTo(currentPos.x, currentPos.y); ctx.lineTo(currentPos.x, axisY); ctx.stroke();
                
                ctx.setLineDash([]); ctx.lineWidth = 2; ctx.strokeStyle = '#6366f1';
                ctx.beginPath(); ctx.moveTo(posA.x, axisY); ctx.lineTo(currentPos.x, axisY); ctx.stroke();
                ctx.fillStyle = '#6366f1'; ctx.fillText(`d=${((currentPos.x-posA.x)*SCALE_M).toFixed(3)}m`, (posA.x+currentPos.x)/2, axisY - 5);
            }
        }

        function resize() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function animate() {
            if (isMoving) {
                progress += 0.005;
                if (progress >= 1) { progress = 1; isMoving = false; statusText.innerText = "Xong!"; checkButtons(); }
                currentPos = getPositionAt(progress);
                updateCalculations();
            }
            draw();
            requestAnimationFrame(animate);
        }
        init();
    </script>
</body>
</html>

