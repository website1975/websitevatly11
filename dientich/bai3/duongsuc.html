<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phòng Thí Nghiệm Điện Trường Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-dark: #020617;
            --panel-bg: rgba(15, 23, 42, 0.85);
            --pos-color: #f87171;
            --neg-color: #60a5fa;
            --accent: #8b5cf6;
        }

        body {
            background-color: var(--bg-dark);
            color: #f8fafc;
            overflow: hidden;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Lưới nền tinh tế */
        .canvas-container {
            position: relative;
            cursor: crosshair;
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
            background-size: 40px 40px;
        }

        /* Hiệu ứng điện tích */
        .charge {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            cursor: grab;
            user-select: none;
            position: absolute;
            z-index: 50;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .charge:hover { transform: scale(1.15); }
        .charge:active { cursor: grabbing; transform: scale(0.95); }

        .charge-positive {
            background: radial-gradient(circle at 30% 30%, #ef4444, #7f1d1d);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5), inset 0 0 10px rgba(255,255,255,0.3);
        }

        .charge-negative {
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1e3a8a);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5), inset 0 0 10px rgba(255,255,255,0.3);
        }

        /* Bảng điều khiển hiệu ứng kính mờ */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .storage-area {
            background: linear-gradient(to top, rgba(15, 23, 42, 0.95), transparent);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Tab styling */
        .tab-btn {
            position: relative;
            padding-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: #64748b;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: var(--accent);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            border-radius: 2px;
        }

        /* Custom Slider */
        input[type=range] {
            height: 6px;
            -webkit-appearance: none;
            background: #334155;
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Animation khi thả */
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .drop-ripple {
            position: absolute;
            border: 2px solid white;
            border-radius: 50%;
            animation: ripple 0.6s ease-out forwards;
            pointer-events: none;
        }

        /* Nội dung lý thuyết */
        .theory-content {
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }
        .theory-content::-webkit-scrollbar {
            width: 4px;
        }
        .theory-content::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 4px;
        }
    </style>
</head>
<body class="h-screen flex">

    <!-- Panel Trái: Khu vực mô phỏng -->
    <div class="flex-grow flex flex-col h-full overflow-hidden">
        <div id="sim-top" class="relative flex-grow canvas-container overflow-hidden">
            <div id="field-probe" class="absolute pointer-events-none bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] border border-white/10 hidden z-50">
                E: <span id="probe-value">0</span> V/m
            </div>
            <canvas id="fieldCanvas"></canvas>
            <div id="charge-layer" class="absolute inset-0 pointer-events-none"></div>
        </div>

        <!-- Phần 2: Kho chứa -->
        <div id="sim-bottom" class="h-40 storage-area p-4 flex flex-col">
            <div class="text-center mb-2">
                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-blue-400/70">Thiết bị thí nghiệm</span>
            </div>
            <div class="flex gap-16 items-center justify-center h-full">
                <div class="flex flex-col items-center gap-2 group">
                    <div id="source-pos" class="charge charge-positive w-14 h-14 text-2xl relative" draggable="true" style="position: relative;">+</div>
                    <span class="text-[9px] font-medium text-slate-500 group-hover:text-red-400 transition-colors uppercase tracking-widest">Dương điện</span>
                </div>
                <div class="flex flex-col items-center gap-2 group">
                    <div id="source-neg" class="charge charge-negative w-14 h-14 text-2xl relative" draggable="true" style="position: relative;">-</div>
                    <span class="text-[9px] font-medium text-slate-500 group-hover:text-blue-400 transition-colors uppercase tracking-widest">Âm điện</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Phải: Tab hệ thống -->
    <div class="w-85 glass-panel flex flex-col shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="p-6 text-center border-bottom border-white/5">
            <h1 class="text-xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-red-400">
                ELECTRO LAB
            </h1>
            <div class="flex justify-center gap-6 mt-6 border-b border-white/5">
                <button onclick="switchTab('control')" id="tab-btn-control" class="tab-btn active uppercase">Điều khiển</button>
                <button onclick="switchTab('theory')" id="tab-btn-theory" class="tab-btn uppercase">Nhận xét lý thuyết</button>
            </div>
        </div>

        <!-- Tab Content: Điều khiển -->
        <div id="tab-control" class="flex-grow p-6 flex flex-col gap-6 overflow-y-auto">
            <div class="space-y-6">
                <div class="space-y-4">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hiển thị đồ họa</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <button id="toggle-vectors" class="flex items-center justify-between p-3 rounded-xl bg-slate-800/50 border border-white/5 hover:border-blue-500/50 transition-all">
                            <span class="text-xs">Lưới Vector (E)</span>
                            <div class="w-4 h-4 rounded-full border-2 border-blue-500 flex items-center justify-center">
                                <div id="dot-vectors" class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            </div>
                        </button>
                        <button id="toggle-lines" class="flex items-center justify-between p-3 rounded-xl bg-slate-800/50 border border-white/5 hover:border-purple-500/50 transition-all">
                            <span class="text-xs">Đường sức điện</span>
                            <div class="w-4 h-4 rounded-full border-2 border-purple-500 flex items-center justify-center">
                                <div id="dot-lines" class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Độ mịn hệ thống</h3>
                    <div class="bg-slate-800/30 p-4 rounded-2xl border border-white/5">
                        <input type="range" id="grid-density" min="25" max="65" value="40" class="w-full">
                    </div>
                </div>

                <button id="clear-btn" class="w-full py-4 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white border border-red-500/30 rounded-2xl font-black transition-all duration-300 uppercase text-[10px] tracking-[0.2em]">
                    Làm sạch phòng Lab
                </button>
            </div>

            <div class="mt-auto p-4 rounded-2xl bg-white/5 border border-white/5 text-[10px] text-slate-500 italic">
                Sử dụng các thanh trượt và nút bấm để tùy chỉnh môi trường mô phỏng.
            </div>
        </div>

        <!-- Tab Content: Lý thuyết -->
        <div id="tab-theory" class="flex-grow p-6 flex flex-col gap-6 overflow-y-auto hidden theory-content">
            <div class="space-y-6">
                <!-- Mục 1 -->
                <section class="space-y-3">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest">1. Khái niệm đường sức điện</h3>
                    <div class="p-4 rounded-2xl bg-slate-800/40 border border-blue-500/20 leading-relaxed text-xs text-slate-300">
                        <p class="mb-2">Đường sức điện là đường mà tiếp tuyến tại mỗi điểm của nó là giá của vectơ cường độ điện trường tại điểm đó.</p>
                        <p>Nói cách khác, đường sức điện là đường mà lực điện tác dụng dọc theo đó.</p>
                    </div>
                </section>

                <!-- Mục 2 -->
                <section class="space-y-3">
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest">2. Tính chất đường sức</h3>
                    <div class="space-y-3">
                        <div class="p-4 rounded-xl bg-slate-800/20 border border-white/5 text-xs">
                            <span class="text-purple-400 font-bold">● Duy nhất:</span> Qua mỗi điểm trong điện trường có một và chỉ một đường sức điện. Các đường sức không bao giờ cắt nhau.
                        </div>
                        <div class="p-4 rounded-xl bg-slate-800/20 border border-white/5 text-xs">
                            <span class="text-purple-400 font-bold">● Hướng:</span> Đường sức điện là những đường có hướng. Hướng của đường sức điện tại một điểm là hướng của vectơ cường độ điện trường tại điểm đó.
                        </div>
                        <div class="p-4 rounded-xl bg-slate-800/20 border border-white/5 text-xs">
                            <span class="text-purple-400 font-bold">● Điểm đầu/cuối:</span> Đường sức điện trường tĩnh là những đường không khép kín. Nó đi ra từ điện tích dương và kết thúc ở điện tích âm (hoặc ở vô cực).
                        </div>
                        <div class="p-4 rounded-xl bg-slate-800/20 border border-white/5 text-xs">
                            <span class="text-purple-400 font-bold">● Mật độ:</span> Nơi nào cường độ điện trường lớn thì các đường sức điện sẽ được vẽ dày (mau), nơi nào cường độ điện trường nhỏ thì các đường sức điện sẽ được vẽ thưa.
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('fieldCanvas');
        const ctx = canvas.getContext('2d');
        const simTop = document.getElementById('sim-top');
        const probe = document.getElementById('field-probe');
        const probeVal = document.getElementById('probe-value');
        const gridDensityInput = document.getElementById('grid-density');
        const clearBtn = document.getElementById('clear-btn');

        let charges = [];
        let isDragging = false;
        let activeCharge = null;
        let showVectors = true;
        let showLines = true;

        // Quản lý Tab
        function switchTab(tabId) {
            document.getElementById('tab-control').classList.add('hidden');
            document.getElementById('tab-theory').classList.add('hidden');
            document.getElementById('tab-btn-control').classList.remove('active');
            document.getElementById('tab-btn-theory').classList.remove('active');

            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('tab-btn-' + tabId).classList.add('active');
        }

        function resize() {
            canvas.width = simTop.clientWidth;
            canvas.height = simTop.clientHeight;
        }

        window.addEventListener('resize', resize);
        resize();

        // Xử lý kéo thả điện tích
        [document.getElementById('source-pos'), document.getElementById('source-neg')].forEach(source => {
            source.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', source.id === 'source-pos' ? 1 : -1);
            });
        });

        simTop.addEventListener('dragover', (e) => e.preventDefault());
        simTop.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = parseInt(e.dataTransfer.getData('type'));
            const rect = simTop.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const rip = document.createElement('div');
            rip.className = 'drop-ripple';
            rip.style.left = x + 'px';
            rip.style.top = y + 'px';
            rip.style.width = '10px'; rip.style.height = '10px';
            simTop.appendChild(rip);
            setTimeout(() => rip.remove(), 600);

            addCharge(x, y, type);
        });

        function addCharge(x, y, type) {
            const id = Date.now();
            const chargeObj = { id, x, y, type, value: type * 100 };
            charges.push(chargeObj);
            
            const el = document.createElement('div');
            el.className = `charge ${type > 0 ? 'charge-positive' : 'charge-negative'}`;
            el.style.left = `${x - 22}px`;
            el.style.top = `${y - 22}px`;
            el.innerText = type > 0 ? '+' : '-';
            el.id = `charge-${id}`;
            
            el.onmousedown = (e) => {
                isDragging = true;
                activeCharge = chargeObj;
                e.stopPropagation();
            };

            simTop.appendChild(el);
        }

        simTop.onmousemove = (e) => {
            const rect = simTop.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            if (isDragging && activeCharge) {
                activeCharge.x = mx;
                activeCharge.y = my;
                const el = document.getElementById(`charge-${activeCharge.id}`);
                el.style.left = `${mx - 22}px`;
                el.style.top = `${my - 22}px`;
            }

            if (charges.length > 0) {
                const field = getFieldAt(mx, my);
                probe.style.display = 'block';
                probe.style.left = (mx + 15) + 'px';
                probe.style.top = (my + 15) + 'px';
                probeVal.innerText = Math.round(field.magnitude);
            } else {
                probe.style.display = 'none';
            }
        };

        window.onmouseup = () => {
            isDragging = false;
            activeCharge = null;
        };

        function getFieldAt(x, y) {
            let ex = 0, ey = 0;
            const k = 2000; 

            charges.forEach(q => {
                const dx = x - q.x;
                const dy = y - q.y;
                const d2 = dx*dx + dy*dy;
                const d = Math.sqrt(d2);
                if (d < 10) return;
                const f = (k * q.value) / d2;
                ex += f * (dx/d);
                ey += f * (dy/d);
            });
            return { ex, ey, magnitude: Math.sqrt(ex*ex + ey*ey) };
        }

        function drawFieldLine(startX, startY, dir) {
            let x = startX, y = startY;
            ctx.beginPath();
            ctx.moveTo(x, y);

            for (let i = 0; i < 150; i++) {
                const f = getFieldAt(x, y);
                if (f.magnitude < 0.1) break;

                x += (f.ex / f.magnitude) * 5 * dir;
                y += (f.ey / f.magnitude) * 5 * dir;

                ctx.lineTo(x, y);

                let stop = false;
                for (let q of charges) {
                    if (Math.sqrt((x-q.x)**2 + (y-q.y)**2) < 20) { stop = true; break; }
                }
                if (stop || x < 0 || x > canvas.width || y < 0 || y > canvas.height) break;
            }
            ctx.stroke();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (charges.length === 0) {
                requestAnimationFrame(animate);
                return;
            }

            if (showLines) {
                ctx.lineWidth = 1.2;
                charges.forEach(q => {
                    const lines = 12;
                    for (let i = 0; i < lines; i++) {
                        const angle = (i/lines) * Math.PI * 2;
                        const startX = q.x + Math.cos(angle) * 22;
                        const startY = q.y + Math.sin(angle) * 22;
                        ctx.strokeStyle = q.type > 0 ? 'rgba(248, 113, 113, 0.2)' : 'rgba(96, 165, 250, 0.2)';
                        drawFieldLine(startX, startY, q.type);
                    }
                });
            }

            if (showVectors) {
                const density = parseInt(gridDensityInput.value);
                for (let x = density/2; x < canvas.width; x += density) {
                    for (let y = density/2; y < canvas.height; y += density) {
                        const f = getFieldAt(x, y);
                        if (f.magnitude < 0.5) continue;

                        const angle = Math.atan2(f.ey, f.ex);
                        const len = Math.min(f.magnitude * 0.4, density * 0.6);
                        const opacity = Math.min(f.magnitude / 15, 0.6);

                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle);
                        ctx.strokeStyle = `rgba(139, 92, 246, ${opacity})`;
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        ctx.moveTo(-len/2, 0);
                        ctx.lineTo(len/2, 0);
                        ctx.lineTo(len/2 - 4, -3);
                        ctx.moveTo(len/2, 0);
                        ctx.lineTo(len/2 - 4, 3);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            }

            requestAnimationFrame(animate);
        }

        document.getElementById('toggle-vectors').onclick = function() {
            showVectors = !showVectors;
            document.getElementById('dot-vectors').style.opacity = showVectors ? '1' : '0';
        };

        document.getElementById('toggle-lines').onclick = function() {
            showLines = !showLines;
            document.getElementById('dot-lines').style.opacity = showLines ? '1' : '0';
        };

        clearBtn.onclick = () => {
            charges = [];
            document.querySelectorAll('#sim-top .charge').forEach(el => el.remove());
        };

        animate();
    </script>
</body>
</html>